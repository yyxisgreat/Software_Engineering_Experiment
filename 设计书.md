# 目录树备份/还原软件 - 软件工程设计书

## 1. 项目概述

### 1.1 项目简介
本项目是一个基于 C++17 的 Linux 目录树备份与还原工具，支持文件数据备份、元数据保存（权限和时间戳）以及路径过滤功能。项目采用模块化设计，核心功能与 CLI 解耦，便于未来扩展 GUI 界面。

### 1.2 主要功能
- ✅ **数据备份**: 将目录树中的文件数据保存到指定备份仓库
- ✅ **数据还原**: 将备份仓库中的文件数据恢复到指定位置
- ✅ **符号链接支持**: 最小实现符号链接的备份和还原
- ✅ **元数据支持**: 保存和恢复文件权限（mode）和修改时间（mtime）
- ✅ **路径过滤**: 支持 include/exclude 路径规则

### 1.3 技术栈
- **编程语言**: C++17
- **构建系统**: CMake 3.10+
- **标准库**: C++17 标准库 + Linux POSIX 系统调用
- **依赖**: 无第三方库依赖

---

## 2. 系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    CLI 接口层                           │
│                  (main.cpp)                            │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                    GUI 接口层                           │
│            (gui/gui_interface.cpp/h)                   │
│          - ProgressCallback 进度回调                    │
│          - GuiOperations GUI操作接口                    │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                   核心业务层                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │   Backup     │  │   Restore    │  │  Repository  │ │
│  │  (backup.cpp)│  │(restore.cpp) │  │(repository.cpp)│ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘ │
│         │                  │                  │         │
│  ┌──────▼──────────────────▼──────────────────▼───────┐ │
│  │         FileUtils (file_utils.cpp/h)              │ │
│  │         文件操作工具函数                            │ │
│  └────────────────────────────────────────────────────┘ │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                   功能模块层                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  Metadata    │  │   Filters    │  │   Storage    │ │
│  │ (metadata/)  │  │  (filters/)  │  │  (storage/)  │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 2.2 设计原则

1. **分层架构**: CLI/GUI 接口层 → 核心业务层 → 功能模块层
2. **解耦设计**: 核心功能独立于 CLI，便于扩展 GUI
3. **接口预留**: 通过抽象基类预留扩展点（FilterBase, PackStore, Compressor, Encryptor）
4. **无第三方依赖**: 仅使用 C++17 标准库和 Linux 系统调用

---

## 3. 模块详细说明

### 3.1 CLI 入口模块 (`src/main.cpp`)

**功能**: 命令行接口入口，解析用户命令和参数

**主要职责**:
- 解析命令行参数（backup/restore 命令）
- 创建和初始化 Repository 对象
- 创建 Backup 或 Restore 对象并执行操作
- 处理路径过滤器选项（--include/--exclude）

**执行流程**:
```
main() 
  ├─ 解析命令行参数
  ├─ 创建 Repository 对象
  ├─ 如果是 backup 命令:
  │   ├─ 解析过滤器选项
  │   ├─ 创建 PathFilter（如果有）
  │   ├─ 创建 Backup 对象
  │   └─ 调用 backup.execute()
  └─ 如果是 restore 命令:
      ├─ 加载仓库索引
      ├─ 创建 Restore 对象
      └─ 调用 restore.execute()
```

---

### 3.2 核心业务模块 (`src/core/`)

#### 3.2.1 Repository (`repository.cpp/h`)

**功能**: 备份仓库管理，负责文件的存储和索引管理

**主要职责**:
- 初始化仓库目录结构（创建 `data/` 目录和 `index.txt` 文件）
- 存储文件到仓库（`storeFile()`）
- 从仓库恢复文件（`restoreFile()`）
- 保存/加载索引文件（`saveIndex()` / `loadIndex()`）
- 提供文件列表和元数据查询接口

**仓库结构**:
```
<仓库路径>/
├── data/              # 文件数据存储目录
│   └── <相对路径>/    # 按原目录结构存储文件
└── index.txt          # 文件索引和元数据
```

**索引文件格式** (`index.txt`):
```
<相对路径>\t<mode>:<mtime>:<uid>:<gid>:<is_symlink>:<symlink_target>
```

**关键方法**:
- `initialize()`: 创建仓库目录结构
- `storeFile()`: 复制文件到 `data/` 目录，并记录元数据到内存索引
- `restoreFile()`: 从 `data/` 目录复制文件，并应用元数据
- `saveIndex()`: 将内存索引序列化到 `index.txt`
- `loadIndex()`: 从 `index.txt` 加载索引到内存

#### 3.2.2 Backup (`backup.cpp/h`)

**功能**: 执行备份操作，遍历源目录并备份文件

**主要职责**:
- 遍历源目录树，收集所有文件
- 应用过滤器（如果有）决定是否备份文件
- 检查文件类型是否支持备份
- 对每个文件调用 `backupFile()` 进行备份
- 统计备份和跳过的文件数量

**执行流程**:
```
Backup::execute()
  ├─ 检查源目录是否存在
  ├─ 使用 FileUtils::getFilesRecursive() 获取所有文件
  ├─ 遍历每个文件:
  │   ├─ 应用过滤器（如果提供）
  │   ├─ 检查文件类型是否支持
  │   └─ 调用 backupFile() 备份单个文件
  │       ├─ 计算相对路径
  │       ├─ 读取文件元数据（Metadata::loadFromFile()）
  │       └─ 调用 Repository::storeFile() 存储文件
  └─ 调用 Repository::saveIndex() 保存索引
```

#### 3.2.3 Restore (`restore.cpp/h`)

**功能**: 执行还原操作，从仓库恢复文件到目标目录

**主要职责**:
- 加载仓库索引
- 遍历索引中的所有文件
- 对每个文件调用 `restoreFile()` 进行还原
- 统计还原成功和失败的文件数量

**执行流程**:
```
Restore::execute()
  ├─ 调用 Repository::loadIndex() 加载索引
  ├─ 调用 Repository::listFiles() 获取文件列表
  ├─ 遍历每个文件:
  │   └─ 调用 restoreFile() 还原单个文件
  │       ├─ 计算目标路径（target_root / relative_path）
  │       └─ 调用 Repository::restoreFile()
  │           ├─ 从 data/ 目录复制文件
  │           ├─ 从索引获取元数据
  │           └─ 应用元数据到目标文件
  └─ 返回操作结果
```

#### 3.2.4 FileUtils (`file_utils.cpp/h`)

**功能**: 文件操作工具函数集合

**主要功能**:
- `getFilesRecursive()`: 递归获取目录下所有文件
- `getRelativePath()`: 计算相对路径
- `copyFile()`: 复制文件（支持符号链接）
- `createDirectories()`: 创建目录结构

---

### 3.3 元数据模块 (`src/metadata/`)

#### 3.3.1 Metadata (`metadata.cpp/h`)

**功能**: 文件元数据管理，保存和恢复文件属性

**存储的元数据**:
- `mode`: 文件权限模式（已实现）
- `mtime`: 修改时间（已实现）
- `uid`: 用户ID（预留接口）
- `gid`: 组ID（预留接口）
- `is_symlink`: 是否为符号链接
- `symlink_target`: 符号链接目标路径

**关键方法**:
- `loadFromFile()`: 从文件系统读取元数据（使用 `stat()` 系统调用）
- `applyToFile()`: 将元数据应用到文件（使用 `chmod()` 和 `utimensat()`）
- `serialize()`: 序列化为字符串（用于保存到索引文件）
- `deserialize()`: 从字符串反序列化

**序列化格式**:
```
<mode>:<mtime>:<uid>:<gid>:<is_symlink>:<symlink_target>
```

#### 3.3.2 FilesystemUtils (`filesystem.cpp/h`)

**功能**: 文件系统类型识别和判断

**主要功能**:
- `getFileType()`: 获取文件类型（普通文件、目录、符号链接等）
- `isBackupSupported()`: 判断文件类型是否支持备份（当前支持普通文件和符号链接）

---

### 3.4 过滤器模块 (`src/filters/`)

#### 3.4.1 FilterBase (`filter_base.cpp/h`)

**功能**: 过滤器抽象基类，定义过滤器接口

**接口方法**:
- `shouldInclude()`: 判断文件是否应该被包含（纯虚函数）
- `getType()`: 返回过滤器类型（纯虚函数）

**过滤器类型枚举**:
- `Path`: 路径过滤器（已实现）
- `FileType`: 文件类型过滤（预留）
- `Name`: 文件名过滤（预留）
- `Time`: 时间过滤（预留）
- `Size`: 大小过滤（预留）
- `User`: 用户过滤（预留）

#### 3.4.2 PathFilter (`path_filter.cpp/h`)

**功能**: 路径过滤器实现，支持 include/exclude 规则

**主要功能**:
- `addInclude()`: 添加包含路径规则
- `addExclude()`: 添加排除路径规则
- `shouldInclude()`: 判断路径是否应该被包含
  - 如果有 exclude 规则匹配，返回 false
  - 如果有 include 规则且匹配，返回 true
  - 如果有 include 规则但不匹配，返回 false
  - 如果只有 exclude 规则，返回 true（默认包含）

**匹配规则**: 当前实现为简单前缀匹配，可扩展为 glob 或正则表达式

---

### 3.5 存储扩展模块 (`src/storage/`)

#### 3.5.1 PackStore (`pack_store.cpp/h`)

**功能**: 打包/解包存储接口（预留）

**接口方法**:
- `pack()`: 将多个文件打包成单个文件
- `unpack()`: 解包文件到指定目录
- `list()`: 列出打包文件中的内容

**当前状态**: 接口已定义，未实现具体功能

#### 3.5.2 Compressor (`compressor.cpp/h`)

**功能**: 压缩/解压接口（预留）

**当前状态**: 接口已定义，未实现具体功能

#### 3.5.3 Encryptor (`encryptor.cpp/h`)

**功能**: 加密/解密接口（预留）

**当前状态**: 接口已定义，未实现具体功能

---

### 3.6 GUI 接口模块 (`src/gui/`)

#### 3.6.1 ProgressCallback (`gui_interface.h`)

**功能**: GUI 进度回调接口，用于在 GUI 界面中显示操作进度

**回调方法**:
- `onStart()`: 操作开始时调用
- `onProgress()`: 文件处理进度更新
- `onFileSuccess()`: 文件处理成功
- `onFileError()`: 文件处理失败
- `onFileSkipped()`: 文件被跳过
- `onComplete()`: 操作完成
- `shouldCancel()`: 检查是否应该取消操作

#### 3.6.2 GuiOperations (`gui_interface.cpp/h`)

**功能**: GUI 友好的操作接口

**主要方法**:
- `backupWithProgress()`: 执行备份操作（带进度回调）
- `restoreWithProgress()`: 执行还原操作（带进度回调）
- `listBackupFiles()`: 列出备份仓库中的文件
- `validateRepository()`: 验证备份仓库是否有效

**实现**: 内部调用 Backup/Restore 类，并通过 ProgressCallback 接口提供进度更新

---

## 4. 执行流程详解

### 4.1 备份流程

```
用户命令: ./backup-restore backup <源目录> <仓库路径> [--include/--exclude ...]

1. main.cpp
   ├─ 解析命令行参数
   ├─ 创建 Repository 对象
   │   └─ Repository::initialize()
   │       └─ 创建仓库目录结构（data/ 目录）
   ├─ 创建 PathFilter（如果有过滤器选项）
   └─ 创建 Backup 对象

2. Backup::execute()
   ├─ 检查源目录是否存在
   ├─ FileUtils::getFilesRecursive() 递归获取所有文件
   ├─ 遍历每个文件:
   │   ├─ PathFilter::shouldInclude() 应用过滤器
   │   ├─ FilesystemUtils::isBackupSupported() 检查文件类型
   │   └─ Backup::backupFile()
   │       ├─ FileUtils::getRelativePath() 计算相对路径
   │       ├─ Metadata::loadFromFile() 读取元数据
   │       │   └─ 使用 stat() 系统调用获取文件属性
   │       └─ Repository::storeFile()
   │           ├─ FileUtils::copyFile() 复制文件到 data/ 目录
   │           └─ 保存元数据到内存索引（index_ map）
   └─ Repository::saveIndex()
       └─ 将内存索引序列化到 index.txt 文件

3. 完成备份，输出统计信息
```

### 4.2 还原流程

```
用户命令: ./backup-restore restore <仓库路径> <目标目录>

1. main.cpp
   ├─ 解析命令行参数
   ├─ 创建 Repository 对象
   └─ Repository::loadIndex()
       └─ 从 index.txt 文件加载索引到内存

2. Restore::execute()
   ├─ Repository::listFiles() 获取文件列表
   ├─ 遍历每个文件:
   │   └─ Restore::restoreFile()
   │       ├─ 计算目标路径（target_root / relative_path）
   │       └─ Repository::restoreFile()
   │           ├─ FileUtils::copyFile() 从 data/ 目录复制文件
   │           ├─ 从内存索引获取元数据
   │           └─ Metadata::applyToFile() 应用元数据
   │               ├─ chmod() 设置文件权限
   │               └─ utimensat() 设置修改时间
   └─ 返回操作结果

3. 完成还原，输出统计信息
```

---

## 5. 文件/文件夹功能说明

### 5.1 项目根目录

```
Software_Engineering_Experiment/
├── CMakeLists.txt          # CMake 构建配置文件
├── README.md               # 项目说明文档
├── build.sh                # 构建脚本（可选）
├── build/                  # 构建输出目录（编译生成）
├── src/                    # 源代码目录
├── test/                   # 测试目录
│   ├── source/            # 测试源目录
│   ├── repo/              # 测试仓库目录
│   └── target/            # 测试目标目录
└── 软件工程设计书.md        # 本文档
```

### 5.2 源代码目录 (`src/`)

#### 5.2.1 入口文件

- **`main.cpp`**: CLI 程序入口，解析命令行参数并调用核心功能

#### 5.2.2 核心模块 (`core/`)

- **`backup.h/cpp`**: 备份操作类，负责遍历目录并备份文件
- **`restore.h/cpp`**: 还原操作类，负责从仓库恢复文件
- **`repository.h/cpp`**: 备份仓库管理类，管理文件存储和索引
- **`file_utils.h/cpp`**: 文件操作工具函数集合

#### 5.2.3 元数据模块 (`metadata/`)

- **`metadata.h/cpp`**: 文件元数据类，保存和恢复文件属性
- **`filesystem.h/cpp`**: 文件系统类型识别工具

#### 5.2.4 过滤器模块 (`filters/`)

- **`filter_base.h/cpp`**: 过滤器抽象基类
- **`path_filter.h/cpp`**: 路径过滤器实现

#### 5.2.5 存储扩展模块 (`storage/`)

- **`pack_store.h/cpp`**: 打包/解包接口（预留）
- **`compressor.h/cpp`**: 压缩/解压接口（预留）
- **`encryptor.h/cpp`**: 加密/解密接口（预留）

#### 5.2.6 GUI 接口模块 (`gui/`)

- **`gui_interface.h/cpp`**: GUI 进度回调和操作接口

### 5.3 构建目录 (`build/`)

- **`backup-restore`**: 编译生成的可执行文件
- **`CMakeFiles/`**: CMake 生成的构建文件
- **`*.o`**: 编译生成的目标文件
- **`CMakeCache.txt`**: CMake 缓存文件

### 5.4 测试目录 (`test/`)

- **`source/`**: 测试用的源目录（备份源）
- **`repo/`**: 测试用的仓库目录（备份目标）
  - **`data/`**: 备份的文件数据
  - **`index.txt`**: 备份索引文件
- **`target/`**: 测试用的目标目录（还原目标）

---

## 6. 数据流设计

### 6.1 备份数据流

```
源文件系统
    │
    ├─ 文件数据 ──────────────┐
    │                         │
    └─ 元数据（stat()）        │
        │                     │
        ▼                     ▼
    Metadata::loadFromFile()  FileUtils::copyFile()
        │                     │
        └───────┬─────────────┘
                │
                ▼
        Repository::storeFile()
                │
        ┌───────┴───────┐
        │               │
        ▼               ▼
    data/目录      index_ (内存)
        │               │
        │               └─→ Repository::saveIndex()
        │                       │
        │                       ▼
        │                   index.txt
        │
        └─→ 备份仓库文件系统
```

### 6.2 还原数据流

```
备份仓库
    │
    ├─ index.txt ────────────┐
    │                        │
    └─ data/目录             │
        │                    │
        │                    ▼
        │            Repository::loadIndex()
        │                    │
        │                    ▼
        │                index_ (内存)
        │                    │
        └────────────────────┘
                │
                ▼
        Repository::restoreFile()
                │
        ┌───────┴───────┐
        │               │
        ▼               ▼
    FileUtils::copyFile()  Metadata::applyToFile()
        │               │
        │               └─→ chmod() / utimensat()
        │
        ▼
    目标文件系统
```

---

## 7. 关键数据结构

### 7.1 Repository 索引结构

```cpp
// 内存中的索引结构
std::map<std::filesystem::path, Metadata> index_;
// key: 相对路径
// value: 文件元数据
```

### 7.2 Metadata 结构

```cpp
class Metadata {
    std::uint32_t mode;          // 文件权限
    std::time_t mtime;           // 修改时间
    std::uint32_t uid;           // 用户ID（预留）
    std::uint32_t gid;           // 组ID（预留）
    bool is_symlink;             // 是否为符号链接
    std::string symlink_target;  // 符号链接目标
};
```

### 7.3 索引文件格式

```
<相对路径>\t<mode>:<mtime>:<uid>:<gid>:<is_symlink>:<symlink_target>
```

示例:
```
doc/file.txt	0644:1234567890:1000:1000:0:
link/to/file	0777:1234567890:1000:1000:1:/path/to/target
```

---

## 8. 扩展接口说明

### 8.1 过滤器扩展

要添加新的过滤器类型：

1. 继承 `FilterBase` 类
2. 实现 `shouldInclude()` 方法
3. 实现 `getType()` 方法返回新类型
4. 在 `FilterBase::Type` 枚举中添加新类型

示例（伪代码）:
```cpp
class SizeFilter : public FilterBase {
    bool shouldInclude(const std::filesystem::path& path) const override {
        // 根据文件大小判断
    }
    Type getType() const override { return Type::Size; }
};
```

### 8.2 存储扩展

#### 8.2.1 实现压缩功能

1. 实现 `Compressor` 接口
2. 在 `Repository::storeFile()` 中集成压缩
3. 在 `Repository::restoreFile()` 中集成解压

#### 8.2.2 实现打包功能

1. 实现 `PackStore` 接口
2. 定义打包数据格式
3. 在仓库存储层集成打包功能

#### 8.2.3 实现加密功能

1. 实现 `Encryptor` 接口
2. 在存储文件前加密，在恢复文件后解密

### 8.3 GUI 扩展

项目已提供完整的 GUI 接口：

1. 实现 `ProgressCallback` 接口来接收进度更新
2. 调用 `GuiOperations::backupWithProgress()` 或 `restoreWithProgress()`
3. 在后台线程中执行操作，避免阻塞 UI

---

## 9. 错误处理机制

### 9.1 错误处理策略

- **文件操作错误**: 使用 try-catch 捕获异常，输出错误信息，继续处理其他文件
- **仓库初始化错误**: 返回 false，程序退出
- **索引加载错误**: 返回 false，程序退出
- **元数据应用错误**: 输出警告，但不影响文件复制（文件已成功复制）

### 9.2 错误信息输出

- 使用 `std::cerr` 输出错误信息
- 错误信息包含文件路径和错误原因
- 操作完成后输出统计信息（成功/失败/跳过数量）

---

## 10. 性能考虑

### 10.1 当前实现

- **文件复制**: 使用标准文件流逐字节复制（可优化为使用系统调用）
- **索引存储**: 使用文本文件存储，每次全量读写（可优化为增量更新）
- **内存使用**: 索引全部加载到内存（适合中小型备份）

### 10.2 优化建议

1. **大文件处理**: 使用流式处理，避免一次性加载到内存
2. **增量备份**: 实现文件哈希比较，只备份修改的文件
3. **并行处理**: 使用多线程并行处理多个文件
4. **索引优化**: 使用数据库或二进制格式存储索引

---

## 11. 测试说明

### 11.1 测试目录结构

```
test/
├── source/          # 测试源目录
│   └── love.txt    # 测试文件
├── repo/            # 测试仓库
│   ├── data/        # 备份数据
│   └── index.txt    # 索引文件
└── target/          # 还原目标目录
```

### 11.2 测试流程

1. **备份测试**:
   ```bash
   ./backup-restore backup test/source test/repo
   ```

2. **验证备份**:
   - 检查 `test/repo/data/` 目录中是否有备份文件
   - 检查 `test/repo/index.txt` 是否包含文件记录

3. **还原测试**:
   ```bash
   ./backup-restore restore test/repo test/target
   ```

4. **验证还原**:
   - 检查 `test/target/` 目录中是否有还原文件
   - 验证文件内容和元数据是否正确

---

## 12. 总结

本项目采用模块化设计，核心功能与接口层解耦，便于扩展和维护。主要特点：

1. **清晰的架构**: 分层设计，职责明确
2. **可扩展性**: 预留多个扩展接口
3. **无依赖**: 仅使用标准库和系统调用
4. **完整性**: 支持文件数据、元数据和符号链接的备份还原

通过本文档，您可以全面了解项目的整体设计、执行流程和各个模块的功能，为后续的开发和维护提供参考。
